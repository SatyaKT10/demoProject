<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.0.0/magnific-popup.min.css" integrity="sha512-nIm/JGUwrzblLex/meoxJSPdAKQOe2bLhnrZ81g5Jbh519z8GFJIWu87WAhBH+RAyGbM4+U3S2h+kL5JoV6/wA==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.0.0/jquery.magnific-popup.min.js" integrity="sha512-+m6t3R87+6LdtYiCzRhC5+E0l4VQ9qIT1H9+t1wmHkMJvvUQNI5MKKb7b08WL4Kgp9K0IBgHDSLCRJk05cFUYg==" crossorigin="anonymous"></script>
<script>
  {% if customer %}  
  {% else %}
  window.location.href = "https://aqualensb2b.com/account/login";
  {% endif %}
</script>
<style>
  @media(max-width:749px){
    .order__allDetails-background .order-header {
      display:none;
    }
    .order__allDetails{
      margin-top:0px !important;
    }
    .order-summary__flex {
      padding: 18px 15px 15px 15px;
      margin: 0px 0px 10px 0px;
    }
    .footer__section{
      display:block;

    }
  }
  
   @media(min-width:749px){
    .order__allDetails-background{
      background: #F8F8F8;
    }
    .order__allDetails{
      height: auto;
      border-radius: 4px;
      background: white;
      box-shadow: 0 0 6px #00000029;
      max-width:500px;
      margin:auto;
    }
    
  }
  .footer__section{
    display:none;

  }
  .order__allDetails-background .order-header {
    color: black;
    font-weight: 700;
    font-size: 17px;
    text-align: center;
    padding: 10px 0px;
  }
  .order-summary__flex {
    padding: 18px 15px 15px 15px;
    background: white;
    margin: 0px 0px 10px 0px;
  }
  .order__tracking-header {
    font-family: Poppins;
    font-style: normal;
    font-weight: 600;
    font-size: 14px;
    line-height: 21px;
    color: #333333;
    text-align: center;
  }
  .progress-content {
    padding: 15px 0 25px;
    margin: 0 auto;
    display: flex;
    justify-content: center;
  }
  .bar.done, .circle.done {
    border: none;
  }
  .bar, .circle {
    display: inline-block;
    background: #fff;
    width: 16px;
    height: 16px;
    border-radius: 50%;
  }
  .circle.done .label {
    color: #fff;
    background: #27c564;
    box-shadow: inset 0 0 2px rgb(0 0 0 / 20%);
  }
  .circle .label {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    font-size: 12px;
    background: #C4C4C4;
  }
  .circle.done .title {
    color: #000;
  }
  .circle .title {
    color: #C4C4C4;
    margin-top: 5px;
    display: block;
    min-width: 80px;
    margin-left: -10px;
    font-family: Poppins;
    font-style: normal;
    font-weight: 600;
    font-size: 8px;
    line-height: 12px;
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }
  .circle .label {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    font-size: 12px;
    background: #C4C4C4;
  }
  .bar {
    background: #3DAD4C;
    border: none;
  }
  .bar {
    position: relative;
    max-width: calc(100% - 11px);
    width: 68px;
    height: 2px;
    top: -28px;
    margin-left: -5px;
    margin-right: 0;
    border-left: none;
    border-right: none;
    border-radius: 0;
  }
  .bar.grey {
    background: #C4C4C4;
  }
  .order__tracking-expected {
    display: flex;
    gap: 10px;
    padding: 10px 0px;
    font-family: Poppins;
    font-style: normal;
    font-weight: 500;
    font-size: 12px;
    line-height: 18px;
    color: #999999;
    border-top: 1px solid #F8F8F8;
    border-bottom: 1px solid #F8F8F8;
    margin-bottom:16px;
    align-items: baseline;
  }
  p.order__tracking-expected-title {
    margin: 1px 0px;
}
  .order__tracking-expected-date {
    color: #333333;
    font-weight: 600;
  }
  .downInvoice__btn {
    text-align: center;
  }
  .invoice_return_btn {
    display: flex;
    justify-content: space-between;
    align-items:center;
    flex-direction: row-reverse;
  }
  .seeInvoice__btn {
    border: 1px solid #00BAC6;
    box-sizing: border-box;
    border-radius: 4px;
    padding: 8px 24px;
    text-align: center;
    font-family: Poppins;
    font-style: normal;
    font-weight: 600;
    font-size: 14px;
    line-height: 21px;
    color: #00BAC6;
    cursor: pointer;
    background: white;
  }
  .marginBottom{
    margin-bottom:20px !important;
  }
  .order__allDetails{
    margin-top: 0px;
    background: #F8F8F8;
    padding: 1px 0px;
    max-width:500px;
  }
  .order__summary-details {
    background: white;
    margin: 15px 0px;
    padding: 15px;
  }
  .allDetails__info {
    margin: 15px 0px;
    padding: 15px;
    background: white;
  }
  .orderInfo__heading {
    font-family: Poppins;
    font-style: normal;
    font-weight: 600;
    font-size: 16px;
    line-height: 24px;
    color: #333333;
    text-transform: capitalize;
    margin-bottom: 10px;
    letter-spacing:0;
  }
  .summary__address-content {
    background: #F8F8F8;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 15px;
    font-family: 'Poppins';
    font-style: normal;
    font-weight: 500;
    font-size: 12px;
    line-height: 18px;
    text-transform: capitalize;
    color: #666666;
  }
  p.paymentDetails-margin {
    background: #F8F8F8;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 10px;
    font-family: 'Poppins';
    font-style: normal;
    font-weight: 500;
    font-size: 12px;
    line-height: 18px;
    color: #666666;
  }
  .orderSummary_total {
    display: flex;
    align-items: baseline;
    font-family: Poppins;
    font-style: normal;
    font-weight: 500;
    font-size: 12px;
    line-height: 18px;
    color: #666666;
  }
  p.orderSummary__title {
    width: 50%;
    font-family: Poppins;
    font-style: normal;
    font-weight: 500;
    font-size: 12px;
    line-height: 18px;
    color: #666666;
    margin-bottom: 1px;
  }
  p.orderSummary__text {
    width: 50%;
    font-family: Poppins;
    font-style: normal;
    font-weight: 500;
    font-size: 12px;
    line-height: 18px;
    color: #333333;
  }
  .status-separator {
    margin: 11px 0px;
    border-top: 1px solid #E0E0E0;
    width: 100%;
  } 
  .loader-main {
  position: fixed;
  height: 100%;
  width: 100%;
  display: flex;
  flex-wrap: nowrap;
  align-items: center;
  justify-content: center;
  z-index: 999999999;
/*   background: rgba(0,0,0,0.31); */
    background:white;
    opacity: 0.9;
  }
  .loader-main p{
/*     background: #ddd; */
    height: 100px;
/*     border-radius: 1000px; */
    width: 100px;

  }
  .return__btn{
    border: 1px solid #00BAC6;
    box-sizing: border-box;
    border-radius: 4px;
    padding: 8px 15px;
    text-align: center;
    font-family: Poppins;
    font-style: normal;
    font-weight: 600;
    font-size: 14px;
    line-height: 21px;
    color: #00BAC6;
    cursor:pointer;
  }
/*   return summary */
  .return_summary_wrapper h4 {
    font-family: Poppins;
    font-style: normal;
    font-weight: 600;
    font-size: 16px;
    line-height: 24px;
    color: #333333;
    text-transform: capitalize;
    margin-bottom: 10px;
    letter-spacing: 0;
}
  .returnSummary__line {
    display: flex;
    align-items: baseline;
    font-family: Poppins;
    font-style: normal;
    font-weight: 500;
    font-size: 12px;
    line-height: 18px;
    color: #666666;
  }
  .returnSummary__heanding {
    width: 50%;
    font-family: Poppins;
    font-style: normal;
    font-weight: 500;
    font-size: 12px;
    line-height: 18px;
    color: #666666;
    margin-bottom: 1px;
  }
  .returnSummary__text {
    width: 50%;
    font-family: Poppins;
    font-style: normal;
    font-weight: 500;
    font-size: 12px;
    line-height: 18px;
    color: #333333;
  }

</style>

{% include 'mobile-header' %}
<div class="nav__mobile--show">
  <div class="cart__header">
    <div class="cart__header-icon">
      <button onclick="history.back()" style="border:none;background:white;outline:none;">
        <img
             src="https://cdn.shopify.com/s/files/1/0291/0417/7212/files/Vector_d5278b25-dd24-415c-a4a0-e7054ded05cd.png?v=1617650787">

      </button>
    </div>
    <div class="cart-head">
      <span class="cart__heading">My Orders</span>
    </div>

    <div class="{% if shop.customer_accounts_enabled %} site-header__icons--plus{% endif %} mobile-cart ">

      <div class="header__cart">
        <a href="/cart">
          <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="17" viewBox="0 0 16 17"
                     fill="none">
            <path
                  d="M7.25277 0.75C6.98333 0.75 6.71413 0.853582 6.50863 1.05908L5.75277 1.81494H8.75277L7.99691 1.05908C7.79141 0.853582 7.52221 0.75 7.25277 0.75ZM11.0028 0.75C10.7333 0.75 10.4641 0.853582 10.2586 1.05908L9.50277 1.81494H12.5028L11.7469 1.05908C11.5414 0.853582 11.2722 0.75 11.0028 0.75ZM2.55941 1.81494L1.25423 1.8252C1.15495 1.82464 1.05655 1.84381 0.964732 1.88158C0.872914 1.91935 0.789507 1.97497 0.719349 2.04522C0.649191 2.11547 0.593678 2.19895 0.556027 2.29081C0.518377 2.38268 0.499339 2.48111 0.500018 2.58039C0.500696 2.67967 0.521078 2.77782 0.559981 2.86917C0.598884 2.96051 0.655533 3.04322 0.726645 3.11251C0.797757 3.18179 0.881916 3.23626 0.974242 3.27277C1.06657 3.30928 1.16522 3.3271 1.26449 3.3252L2.06722 3.31934L4.53695 9.24609L3.639 10.6816C3.01024 11.6857 3.77478 13.0649 4.95882 13.0649H13.2528C13.3522 13.0663 13.4508 13.048 13.5431 13.0109C13.6353 12.9739 13.7192 12.9188 13.79 12.8491C13.8608 12.7793 13.917 12.6961 13.9553 12.6044C13.9937 12.5127 14.0134 12.4143 14.0134 12.3149C14.0134 12.2155 13.9937 12.1171 13.9553 12.0255C13.917 11.9338 13.8608 11.8506 13.79 11.7808C13.7192 11.711 13.6353 11.656 13.5431 11.619C13.4508 11.5819 13.3522 11.5635 13.2528 11.5649H4.95882C4.87537 11.5649 4.86575 11.5485 4.91048 11.477C4.91097 11.4771 4.91146 11.4771 4.91195 11.477L5.79378 10.0649H11.3939C11.9384 10.0649 12.4409 9.76922 12.7049 9.29297L15.4061 4.42822C15.6843 3.92872 15.3228 3.31494 14.7513 3.31494H3.69027L3.25814 2.27637C3.20075 2.1387 3.10362 2.02127 2.97915 1.93908C2.85469 1.85689 2.70855 1.81367 2.55941 1.81494ZM5.00277 13.8149C4.60494 13.8149 4.22341 13.973 3.94211 14.2543C3.6608 14.5356 3.50277 14.9171 3.50277 15.3149C3.50277 15.7128 3.6608 16.0943 3.94211 16.3756C4.22341 16.6569 4.60494 16.8149 5.00277 16.8149C5.40059 16.8149 5.78212 16.6569 6.06343 16.3756C6.34473 16.0943 6.50277 15.7128 6.50277 15.3149C6.50277 14.9171 6.34473 14.5356 6.06343 14.2543C5.78212 13.973 5.40059 13.8149 5.00277 13.8149ZM12.5028 13.8149C12.1049 13.8149 11.7234 13.973 11.4421 14.2543C11.1608 14.5356 11.0028 14.9171 11.0028 15.3149C11.0028 15.7128 11.1608 16.0943 11.4421 16.3756C11.7234 16.6569 12.1049 16.8149 12.5028 16.8149C12.9006 16.8149 13.2821 16.6569 13.5634 16.3756C13.8447 16.0943 14.0028 15.7128 14.0028 15.3149C14.0028 14.9171 13.8447 14.5356 13.5634 14.2543C13.2821 13.973 12.9006 13.8149 12.5028 13.8149Z"
                  fill="#4F4F4F" />
            </svg></span>
          <span class="cart-count"> {{ cart.item_count }}</span>
        </a>
      </div>
    </div>

  </div>
</div>



<div class="loader-main">
	<p><img class=" lazyloaded" src="https://cdn.shopify.com/s/files/1/0291/0417/7212/files/image_2.png?v=1640198349" data-src="https://cdn.shopify.com/s/files/1/0291/0417/7212/files/image_2.png?v=1640198349" alt="Aqualens Contact lenses"></p>
</div>
<div class="order__allDetails-background">
  {% render 'background-look' %}
  <div class="order-header"> Order Details </div>
  <div class="order__allDetails">
    <div class="orderTrack__details">    
    </div>
    <div class="order__summary-details">
    </div>
    <div class="allDetails__info">
      <div class="order__billing-details"> 
      </div>
      <div class="order__shipping-details"> 
      </div>
      <div class="order__payment-details">
      </div>
    </div>
  </div>
</div>
<script>
  $(document).ready(function() { 
    function orderDetails(orderId){
      let custNewToken =  sessionStorage.getItem("custNewToken");
      var settings = {
        "url": baseURL+"/api/v1/customers/orders/"+orderId,
        "method": "GET",
        "timeout": 0,
        "headers": {
          "Authorization": "Bearer "+custNewToken
        }
      };
      $.ajax(settings).done(function (response) {
        if(response.status == true){
        $('.loader-main').hide();
        console.log(response);
        let summaryHtml = '';
        let shippingHtml = '';
        let paymentHtml = '';      
        var shipping_info = response.data.shipping_details;
        var payment_info = response.data.payment_details;
        var orderSummary_info = response.data.bill_details;
        var trackingHtmlContainer = '';        
        var trackOrderDetails = response.data.order_details;  
        var expectedDateHtml = '';
        if(trackOrderDetails && trackOrderDetails.length > 0){
          trackOrderDetails.forEach(function(i){
            
             let estD = new Date(i.estimated_delivery_date); 
             let ordD = new Date(i.order_date);                                                           

              let options = {
                year: "2-digit",
                month: "short",
                day: "numeric",
              }
              let options2 = {
                hour: "numeric",
                minute: "numeric",
              }
              let orderEstimateDate = Intl.DateTimeFormat("en-IN", options).format(estD); //timeStamp.toDateString();
              let time = Intl.DateTimeFormat("en-IN", options2).format(estD);
              let ordDate = Intl.DateTimeFormat("en-IN", options).format(ordD); //timeStamp.toDateString();
            
//             const months = ["Jan","Feb","March","April","May","June","July","Aug","Sep","Oct","Nov","Dec"];
//             var estD = new Date(i.estimated_delivery_date);
//             var estDay = estD.getDate();
//             var estMonth = months[estD.getMonth()];
//             var estYear = estD.getFullYear();
//             let orderEstimateDate = estDay + "  " + estMonth + ", " + estYear;
//             var ordD = new Date(i.order_date);
//             var ordDay = ordD.getDate();
//             var ordMonth = months[ordD.getMonth()];
//             var ordYear = ordD.getFullYear();
//             let ordDate = ordDay + "  " + ordMonth + ", " + ordYear;  
            
            
            let orderCancelled = false;
            let orderDelivered = false;
            let trackingDetails = i.tracking_details;
            let trackData = Object.entries(trackingDetails)
            let trackingHtml = '';
            let order_status = i.status;
            let invoiceURL = i.invoice;
            let invoiceCTA = '';
            let returnCTAdata = ''
//             let returnSummaryData = '';
            if(invoiceURL == null){
              invoiceCTA = `<a href="#" class="seeInvoice__btn">									
                                   No Invoice Generated                             
                            </a>`
            }else{
              invoiceCTA = `<a href="${invoiceURL}" target="_blank" class="seeInvoice__btn downloadEvent" data-lk-id=${i.lenskart_order_number}>									
                                  Download Invoice                             
                            </a>`
            }
            let estDeliveryDate = true;
            
            trackData.forEach(([key, value],ele) => {
              let tText = trackingDetails[key].status_text;
              let tStatus = trackingDetails[key].step_complete;
              let tCreated = trackingDetails[key].createdTime;
              
//               if(tText != "REFUNDED"){
              if(tText == 'DELIVERED' && tCreated != null && i.order_return.length <= 0 ){
                returnCTAdata = `<a href="https://aqualensb2b.com/pages/return-order?orderID=${i.lenskart_order_number}" class="return__btn">
                               		Return
                                </a>`;              
              }else if(tText == 'DELIVERED' && tCreated != null && i.order_return.length >= 0){
                returnCTAdata = `<div style="color: #00BAC6;font-weight:600;border: 1px solid #00BAC6;border-radius:4px;padding: 6px 12px;font-family: Poppins;font-size: 15px; font-style: normal;background: #E5E5E5;">Returned</div>`; 
                                
              }
              else if( tText == 'CANCELLED' ||  tText != 'IN TRANSIT' ){
                returnCTAdata='';
              }
              
              if(tText == 'DELIVERED' || tText == 'CANCELLED' || tText == 'REFUNDED'){
                estDeliveryDate = false;                
              }
              if(tText != "POWER FOLLOWUP" && tText != "REFUNDED"){
                if(tStatus){
                    trackingHtml += `<div><div class="circle done" status="1">`
                }
                else{
                    trackingHtml += `<div><div class="circle" status="1">`
                }
                trackingHtml +=  `<span class="label"></span>
                        <span class="title">${tText} </span>
                        </div>`
//              if(tText != "CANCELLED"){
                if(ele != trackData.length- 1 && tText != "CANCELLED"){
                    if(tStatus){                        
                        trackingHtml += `<span class="bar" status="1"></span>`                         
                    }else{
                        trackingHtml += `<span class="bar grey" status="1"></span>`
                    }   
                } 
//               }
                trackingHtml += `</div>`     
              }  
//               }
      
            })
            
            if(estDeliveryDate == true ){
              expectedDateHtml = `<div class="order__tracking-expected">
                                    <p class="order__tracking-expected-title">Should reach you by</p>
                                    <p class="order__tracking-expected-date">${orderEstimateDate}</p>
                                 </div>`;
            } else {
              expectedDateHtml = ``;
            }
            
            
            let paymentMode = payment_info.payment_mode.toUpperCase();                      
            let trackingHtmlData = "";
            trackingHtmlData = `<div class="order-summary__flex">
                                    <div class="order__tracking-container mobile__tracker">
                                        <div class="order__tracking-header">Order Tracking</div>
                                        <div class="progress-content" id="progress-content">
                                            ${trackingHtml}
                                        </div>
                                        ${expectedDateHtml}             
                                    </div>  
                                    <div class="orderSummary_total">
                                          <p class="orderSummary__title">Order Id</p>
                                          <p class="orderSummary__text">${i.lenskart_order_number}</p>										  
                                    </div>
                                    <hr class="status-separator">
                                    <div class="orderSummary_total">
                                          <p class="orderSummary__title">Order Placed on</p>
                                          <p class="orderSummary__text">${ordDate}</p>										  
                                    </div>
                                    <hr class="status-separator">

                                    <div class="orderSummary_total">
                                          <p class="orderSummary__title">Payment Mode</p>
                                          <p class="orderSummary__text">${paymentMode}</p>										  
                                    </div>
                                      <hr class="status-separator marginBottom">
                                    <div class="invoice_return_btn">   
									  ${invoiceCTA}	
                                      ${returnCTAdata}									  
                                    </div>
 									
                                </div>`  
            trackingHtmlContainer = trackingHtmlContainer + trackingHtmlData;
            })

            $('.orderTrack__details').html(trackingHtmlContainer);
          }
        
//         order suummary
          let amount_total = 0;
          if(orderSummary_info.total != 0){
            amount_total = orderSummary_info.total;
          }else{
            amount_total = orderSummary_info.wallet_amount_used;
          }
          
        
          if(orderSummary_info != null){
            let summaryHtmlData = `<div class="orderSummary__card">
                                        <h2 class="orderSummary__heading orderInfo__heading">Order Summary</h2>
                                        <div class="orderSummary__details">
                                          <div class="orderSummary_total">
                                            <p class="orderSummary__title">Total</p>
                                            <p class="orderSummary__text">${amount_total}</p>										  
                                          </div>
                                            <hr class="status-separator">
                                        </div>
                                  </div>`
            summaryHtml = summaryHtml + summaryHtmlData;
          } 
          if(shipping_info != null){
          let shippingHtmlData = `<div class="shippingDetails__card">
                                        <h2 class="shippingDetails__heading orderInfo__heading">Shipping Details</h2>
                                  </div>
                                  <div class="summary__address-content">
                                        ${shipping_info.first_name}&nbsp;${shipping_info.first_name} <br>
                                        ${shipping_info.address1}<br>
                                        ${shipping_info.city}, ${shipping_info.province}, ${shipping_info.zip } <br>
                                        <br> Phone: ${shipping_info.phone }
                                  </div>`
          shippingHtml = shippingHtml + shippingHtmlData;
          }
          if(payment_info){          
            if(payment_info.payment_mode != null){
              let paymentMode = payment_info.payment_mode.toUpperCase();
              let paymentHtmlData = `<div class="paymentDetails-content">
                                        <h2 class="paymentDetails__heading orderInfo__heading">Payment Details</h2>
                                        <p class="paymentDetails-margin">Payment Mode:&nbsp; ${paymentMode}</p>
                                    </div>`
              paymentHtml = paymentHtml + paymentHtmlData;
            }
          }
          $('.order__summary-details').html(summaryHtml);
          $('.order__shipping-details').html(shippingHtml);
          $('.order__billing-details').html(shippingHtml);
          $('.order__billing-details .shippingDetails__heading').text("Billing Details"); 
          $('.order__payment-details').html(paymentHtml);

//         ordersummary end
        } 
      }).fail(function(error){
        $('.loader-main').hide();
        let apiError = error.responseJSON.message;
        errorPopup(apiError);
        if(apiError === 'Unauthorized request'){
          setNewToken();
          location.reload();
        }else{
          errorPopup(apiError);
        }
      })
    }
    function orderDetailFn(){
      const urlParams = new URLSearchParams(location.search);
      if(urlParams.has('order')){
        let orderId = urlParams.get('order');
        orderDetails(orderId);
      }
    }
    $(window).on("load",function(){
      orderDetailFn();
    })
    
    $(document).on('click','.downloadEvent',function(){
     let  lenskart_order_id = $(this).attr("data-lk-id");
      //       clevertap events
      clevertap.event.push("Download-Invoice",{
        "lenskartOrderId":lenskart_order_id,
        "Date":  "{{ "now" | date: "%Y-%m-%d" }}"
      });
      //           GA events
      let displayMode = 'browser';
      const mqStandAlone = '(display-mode: standalone)';
      if (navigator.standalone || window.matchMedia(mqStandAlone).matches || navigator.userAgent.toLowerCase().includes('wv')) {
        displayMode = 'standalone';
        dataLayer.push({
          'event': 'Download-Invoice_pwa',
          "lenskartOrderId":lenskart_order_id,
          "Date":  "{{ "now" | date: "%Y-%m-%d" }}"
        })
      }else{
        dataLayer.push({
          'event': 'Download-Invoice',
          "lenskartOrderId":lenskart_order_id,
          "Date":  "{{ "now" | date: "%Y-%m-%d" }}"
        })
      } 
      //          events end
    })
  })
</script>